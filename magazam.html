<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mağazam - VELORA</title>
    <link rel="stylesheet" href="magazam.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <!-- Top Header -->
    <header class="header">
        <div class="header-container">
            <a href="home.html" class="logo-section">
                <img src="logo.png" alt="Velora Logo" class="logo-icon">
                <div class="brand">
                    <h1 class="brand-name">VELORA</h1>
                    <p class="brand-tagline">Kadın üreticilerin dijital pazarı</p>
                </div>
            </a>
           
                <!-- Profile Menu -->
                <div class="user-profile-container">
                    <div class="profile-trigger" onclick="toggleProfileMenu()">
                        <i class="fas fa-user-circle"></i>
                        <span class="profile-text">Profilim</span>
                    </div>
                    <!-- Profile Dropdown -->
                    <div class="profile-menu" id="profileDropdown">
                        <div class="menu-header">
                            <span id="menuUserName">Satıcı</span>
                        </div>
                        <ul class="menu-list">
                            <li><a href="magazam.html"><i class="fas fa-store"></i> Mağazam</a></li>
                            <li><a href="#"><i class="fas fa-cog"></i> Ayarlar</a></li>
                            <li><a href="profil.html"><i class="fas fa-user-edit"></i> Profilimi Düzenle</a></li>
                            <li style="border-top: 1px solid #eee; margin-top: 5px;"><a href="home.html"
                                    onclick="localStorage.removeItem('currentUser');" style="color: #e74c3c;"><i
                                        class="fas fa-sign-out-alt" style="color: #e74c3c;"></i> Çıkış Yap</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <!-- Section 1: Welcome / Login Choices -->
        <div id="welcomeSection" class="welcome-container">
            <i class="fas fa-store-alt" style="font-size: 4rem; color: #8B6B47; margin-bottom: 1rem;"></i>
            <h2 class="welcome-title">Velora Mağaza Paneli</h2>
            <p class="welcome-text">El emeği ürünlerinizi binlerce alıcıyla buluşturun. Mağazanızı yönetin,
                satışlarınızı takip edin ve işinizi büyütün.</p>

            <div class="action-buttons">
                <button class="action-btn btn-primary" onclick="window.location.href='hesap.html'">
                    <i class="fas fa-rocket"></i> Mağaza Aç
                </button>
                <button class="action-btn btn-outline" id="loginStoreBtn">
                    <i class="fas fa-sign-in-alt"></i> Mağazana Giriş Yap
                </button>
            </div>
        </div>

        <!-- Section 2: Store Dashboard -->
        <div id="dashboardSection" class="dashboard-container">
            <div class="dashboard-header">
                <div>
                    <h2 class="dashboard-title" id="welcomeMessage">Hoşgeldiniz</h2>
                    <p style="color: #666; margin-top: 5px;">Mağaza İstatistikleriniz ve Ürün Yönetimi</p>
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <a href="urun.html" class="add-product-btn">
                        <i class="fas fa-plus"></i> Yeni Ürün Ekle
                    </a>
                    <button id="kasaBtn" class="add-product-btn" style="background:linear-gradient(135deg,#ffd54f,#ffb347);" onclick="showCashbox()">
                        <i class="fas fa-cash-register"></i> Kasama Git
                    </button>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card" style="cursor: pointer;" onclick="toggleSection('myProductsSection')" title="Satıştaki ürünlerinizi görmek için tıklayın">
                    <div class="stat-icon icon-purple">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Toplam Ürün</h3>
                        <p id="totalProducts">0</p>
                    </div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="toggleSection('soldProductsSection')" title="Satılan ürünlerinizi görmek için tıklayın">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Satılan Ürün</h3>
                        <p id="totalSoldProducts">0</p>
                    </div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="toggleSection('favoriteProductsSection')" title="Favorilere eklenen ürünlerinizi görmek için tıklayın">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                        <i class="fas fa-heart"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Favorilere Eklenen</h3>
                        <p id="totalFavoritedProducts">0</p>
                    </div>
                </div>
                <div class="stat-card" style="cursor: pointer;" onclick="toggleSection('notificationsSection')" title="Satış bildirimlerinizi görmek için tıklayın">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #3498db, #2980b9);">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Bildirimler</h3>
                        <p id="totalNotifications">0</p>
                    </div>
                </div>
            </div>

            <!-- My Products Section (Hidden by default) -->
            <div id="myProductsSection" style="display: none;">
                <h3 class="products-section-title">Satıştaki Ürünlerim</h3>
                <hr style="margin: 2rem 0; border: none; border-top: 1px solid #eee;">
                <div class="products-section">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
                        <h3 style="margin:0;">Satıştaki Ürünlerim</h3>
                        <div style="display:flex; gap:8px;">
                            <a href="urun.html" class="add-product-btn">
                                <i class="fas fa-plus"></i> Yeni Ürün Ekle
                            </a>
                            <button id="showMyProductsBtn" class="show-products-btn">
                                <i class="fas fa-eye"></i> Ürünlerimi Göster
                            </button>
                        </div>
                    </div>
                    <p style="color:#666; margin-top:6px;">Mağazamda satışa çıkardığınız ürünler burada listelenir.</p>

                    <!-- Products Grid -->
                    <div class="products-grid" id="productsGrid">
                        <!-- Javascript will populate this -->
                    </div>
                </div>
            </div>

            <!-- Sold Products Section (Hidden by default) -->
            <div id="soldProductsSection" style="display: none;">
                <h3 class="products-section-title" style="margin-top: 3rem;">Satılan Ürünlerim</h3>
                <hr style="margin: 2rem 0; border: none; border-top: 1px solid #eee;">
                <div id="soldProductsContainer" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:2rem;">
                    <div style="grid-column:1/-1; text-align:center; padding:2rem; background:#fff; border:1px solid #eee; border-radius:12px; color:#777;">
                        <i class="fas fa-box-open" style="font-size:2rem; color:#bbb; margin-bottom:0.5rem;"></i>
                        <div>Henüz satılan ürün yok.</div>
                    </div>
                </div>
            </div>

            <!-- Favorite Products Section (Hidden by default) -->
            <div id="favoriteProductsSection" style="display: none;">
                <h3 class="products-section-title" style="margin-top: 3rem;">Favorilere Eklenen Ürünlerim</h3>
                <hr style="margin: 2rem 0; border: none; border-top: 1px solid #eee;">
                <div id="favoriteProductsContainer" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:2rem;">
                    <div style="grid-column:1/-1; text-align:center; padding:2rem; background:#fff; border:1px solid #eee; border-radius:12px; color:#777;">
                        <i class="fas fa-box-open" style="font-size:2rem; color:#bbb; margin-bottom:0.5rem;"></i>
                        <div>Henüz favorilere eklenen ürün yok.</div>
                    </div>
                </div>
            </div>

            <!-- Notifications Section (Hidden by default) -->
            <div id="notificationsSection" style="display: none;">
                <h3 class="products-section-title" style="margin-top: 3rem;">Satış Bildirimleri</h3>
                <hr style="margin: 2rem 0; border: none; border-top: 1px solid #eee;">
                <div id="notificationsContainer" style="display:flex; flex-direction:column; gap:12px;">
                    <div style="text-align:center; padding:2rem; background:#fff; border:1px solid #eee; border-radius:12px; color:#777;">
                        <i class="fas fa-bell" style="font-size:2rem; color:#bbb; margin-bottom:0.5rem;"></i>
                        <div>Bildirim yok.</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Cashbox Modal / Animation -->
    <div id="cashboxModal" style="display:none; position:fixed; right:20px; bottom:20px; width:320px; background:#fff; border:1px solid #eee; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.12); overflow:hidden; z-index:1200;">
        <div style="padding:12px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #faf0de; background:linear-gradient(90deg,#fff8e1,#fff3cd);">
            <strong>Kasam</strong>
            <button onclick="closeCashbox()" style="border:none; background:transparent; font-size:18px; cursor:pointer;">✕</button>
        </div>
        <div id="cashboxContent" style="padding:16px;">
            <div style="font-size:14px; color:#666;">Toplam Kazanç</div>
            <div id="cashboxAmount" style="font-size:28px; font-weight:700; margin-top:8px; color:#2d7a2d;">0 TL</div>
            <div style="margin-top:12px; display:flex; gap:8px;">
                <button onclick="withdrawPlaceholder()" style="flex:1; padding:8px; border-radius:8px; border:0; background:#2d7a2d; color:#fff;">Çekim Yap</button>
                <button onclick="refreshCashbox()" style="flex:1; padding:8px; border-radius:8px; border:1px solid #eee; background:#fff;">Yenile</button>
            </div>
        </div>
    </div>

    <!-- Confetti container -->
    <div id="confettiContainer" style="pointer-events:none; position:fixed; left:0; top:0; width:100%; height:100%; z-index:1100; display:none;"></div>

    <script>
        // Global state
        let currentProducts = [];

        document.addEventListener('DOMContentLoaded', () => {
            const welcomeSection = document.getElementById('welcomeSection');
            const dashboardSection = document.getElementById('dashboardSection');
            const loginBtn = document.getElementById('loginStoreBtn');
            const profileMenuContainer = document.getElementById('profileMenuContainer');
            const headerUserName = document.getElementById('headerUserName');
            const welcomeMessage = document.getElementById('welcomeMessage');

            // Check store status
            const isStoreActive = localStorage.getItem('veloraStoreActive') === 'true';
            const storeDetails = JSON.parse(localStorage.getItem('veloraStore') || '{}');

            if (isStoreActive) {
                // Show Dashboard
                welcomeSection.style.display = 'none';
                dashboardSection.style.display = 'block';
                profileMenuContainer.style.display = 'block';

                // Personalize
                const name = storeDetails.ownerName || 'Girişimci';
                document.getElementById('menuUserNameDisplay').textContent = name;
                welcomeMessage.textContent = 'Hoşgeldin, ' + name;

                loadProducts();
                loadStats();
            }

            // Login Button Logic
            loginBtn.addEventListener('click', () => {
                window.location.href = 'magaza-giris.html';
            });
        });

        function toggleProfileMenu() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('active');
        }

        // Close menu when clicking outside
        document.addEventListener('click', function (event) {
            const container = document.querySelector('.user-profile-container');
            const dropdown = document.getElementById('profileDropdown');
            if (container && !container.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        function logoutStore() {
            localStorage.removeItem('veloraStoreActive');
            window.location.reload();
        }

        function loadProducts() {
            currentProducts = JSON.parse(localStorage.getItem('products') || '[]');
            const container = document.getElementById('productsGrid');
            const totalProductsEl = document.getElementById('totalProducts');

            totalProductsEl.textContent = currentProducts.length;
            container.innerHTML = '';

            if (currentProducts.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 3rem; background: white; border-radius: 12px; color: #888;">
                        <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 1rem; color: #ddd;"></i>
                        <p>Henüz satışta ürününüz yok.</p>
                        <a href="urun.html" style="color: #8B6B47; font-weight: 600; margin-top: 10px; display: inline-block;">Hemen ürün ekle</a>
                    </div>
                `;
                return;
            }

            currentProducts.forEach((product, index) => {
                const card = document.createElement('div');
                card.className = 'product-card';

                let imageHTML = '';
                if (product.image) {
                    imageHTML = `<img src="${product.image}" alt="${product.name}">`;
                } else {
                    imageHTML = `
                        <div class="no-image-placeholder">
                            <i class="fas fa-image" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                            <span>Görsel Yok</span>
                        </div>
                    `;
                }

                const views = Math.floor(Math.random() * 50) + 1;
                const favs = Math.floor(Math.random() * 10);

                card.innerHTML = `
                    <div class="product-img-box">
                       ${imageHTML}
                    </div>
                    <div class="product-details">
                        <div class="product-category">${product.category || 'Genel'}</div>
                        <h3 class="product-name" contenteditable="false" id="name-${index}">${product.name}</h3>
                        <div class="product-price" contenteditable="false" id="price-${index}">${product.price} TL</div>
                        
                        <div class="card-actions">
                            <span><i class="fas fa-eye"></i> ${views} Gör.</span>
                            <span><i class="fas fa-heart"></i> ${favs} Fav.</span>
                        </div>

                        <div class="manage-overlay">
                            <button class="btn-sm btn-edit" onclick="enableEdit(${index}, this)">
                                <i class="fas fa-pen"></i> Düzenle
                            </button>
                            <button class="btn-sm btn-delete" onclick="deleteProduct(${index})">
                                <i class="fas fa-trash"></i> Sil
                            </button>
                        </div>
                        <div id="save-actions-${index}" style="display:none; margin-top:10px; gap:5px;">
                             <button class="btn-sm" style="background:#4CAF50; color:white;" onclick="saveEdit(${index})">Kaydet</button>
                             <button class="btn-sm" style="background:#999; color:white;" onclick="cancelEdit(${index})">İptal</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function loadStats() {
            let favorites = JSON.parse(localStorage.getItem('veloraFavorites') || '[]');
            let cart = JSON.parse(localStorage.getItem('veloraCart') || '[]');
            let orders = JSON.parse(localStorage.getItem('orders') || '[]');
            let notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            let productFavorites = JSON.parse(localStorage.getItem('productFavorites') || '{}');
            
            const currentUserEmail = JSON.parse(localStorage.getItem('currentUser') || '{}').email || '';
            
            // Filter orders for current seller
            const sellerOrders = orders.filter(o => o.sellerEmail === currentUserEmail);
            const totalSold = sellerOrders.length;
            
            // Count unique products that have been favorited
            let favoritedCount = 0;
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            
            products.forEach(product => {
                if (product.ownerEmail === currentUserEmail) {
                    const favData = productFavorites[product.id] || { count: 0 };
                    favoritedCount += favData.count || 0;
                }
            });
            
            document.getElementById('totalSoldProducts').textContent = totalSold;
            document.getElementById('totalFavoritedProducts').textContent = favoritedCount;
            document.getElementById('totalNotifications').textContent = notifications.filter(n => n.sellerEmail === currentUserEmail).length;
            
            // Load sold products and notifications (they will be hidden by default)
            loadSoldProducts();
            loadFavoriteProducts();
            loadNotifications();
        }

        // Toggle section visibility
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                if (section.style.display === 'none') {
                    section.style.display = 'block';
                    // Scroll to section
                    section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    section.style.display = 'none';
                }
            }
        }

        function loadSoldProducts() {
            const currentUserEmail = JSON.parse(localStorage.getItem('currentUser') || '{}').email || '';
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const container = document.getElementById('soldProductsContainer');
            
            const sellerOrders = orders.filter(o => o.sellerEmail === currentUserEmail);
            
            if (sellerOrders.length === 0) {
                container.innerHTML = `
                    <div style="grid-column:1/-1; text-align:center; padding:2rem; background:#fff; border:1px solid #eee; border-radius:12px; color:#777;">
                        <i class="fas fa-box-open" style="font-size:2rem; color:#bbb; margin-bottom:0.5rem;"></i>
                        <div>Henüz satılan ürün yok.</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            sellerOrders.forEach(order => {
                const product = products.find(p => p.id === order.productId);
                if (!product) return;
                
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="product-img-box">
                        ${product.image ? `<img src="${product.image}" alt="${product.name}">` : '<div class="no-image-placeholder"><i class="fas fa-image"></i></div>'}
                    </div>
                    <div class="product-details">
                        <div class="product-category">${product.category || 'Genel'}</div>
                        <h3 class="product-name">${product.name}</h3>
                        <div class="product-price">${product.price} TL</div>
                        <div style="margin-top:1rem; padding-top:1rem; border-top:1px solid #eee; font-size:0.9rem; color:#666;">
                            <div><strong>Alıcı:</strong> ${order.buyerName}</div>
                            <div><strong>Tarih:</strong> ${new Date(order.date).toLocaleDateString('tr-TR')}</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function loadFavoriteProducts() {
            const currentUserEmail = JSON.parse(localStorage.getItem('currentUser') || '{}').email || '';
            const products = JSON.parse(localStorage.getItem('products') || '[]');
            const productFavorites = JSON.parse(localStorage.getItem('productFavorites') || '{}');
            const container = document.getElementById('favoriteProductsContainer');
            
            const favorited = [];
            products.forEach(product => {
                if (product.ownerEmail === currentUserEmail && productFavorites[product.id]) {
                    favorited.push({ 
                        productId: product.id, 
                        product: product,
                        count: productFavorites[product.id].count || 1
                    });
                }
            });
            
            if (favorited.length === 0) {
                container.innerHTML = `
                    <div style="grid-column:1/-1; text-align:center; padding:2rem; background:#fff; border:1px solid #eee; border-radius:12px; color:#777;">
                        <i class="fas fa-box-open" style="font-size:2rem; color:#bbb; margin-bottom:0.5rem;"></i>
                        <div>Henüz favorilere eklenen ürün yok.</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            favorited.forEach(item => {
                const product = item.product;
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="product-img-box">
                        ${product.image ? `<img src="${product.image}" alt="${product.name}">` : '<div class="no-image-placeholder"><i class="fas fa-image"></i></div>'}
                    </div>
                    <div class="product-details">
                        <div class="product-category">${product.category || 'Genel'}</div>
                        <h3 class="product-name">${product.name}</h3>
                        <div class="product-price">${product.price} TL</div>
                        <div style="margin-top:1rem; padding-top:1rem; border-top:1px solid #eee; font-size:0.9rem; color:#666;">
                            <div><strong>Favorilere Eklenme Sayısı:</strong> ${item.count}</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function loadNotifications() {
            const currentUserEmail = JSON.parse(localStorage.getItem('currentUser') || '{}').email || '';
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            const container = document.getElementById('notificationsContainer');
            
            const userNotifications = notifications.filter(n => n.sellerEmail === currentUserEmail);
            
            if (userNotifications.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:2rem; background:#fff; border:1px solid #eee; border-radius:12px; color:#777;">
                        <i class="fas fa-bell" style="font-size:2rem; color:#bbb; margin-bottom:0.5rem;"></i>
                        <div>Bildirim yok.</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            userNotifications.slice().reverse().forEach(notif => {
                const notifDiv = document.createElement('div');
                notifDiv.style.cssText = 'padding:1rem; background:#fffbea; border:1px solid #ffe8b6; border-radius:8px; color:#333;';
                notifDiv.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <i class="fas fa-bell" style="color:#f39c12; font-size:1.2rem;"></i>
                        <div>
                            <strong>${notif.productName}</strong> ürünü <strong>${notif.buyerName}</strong> tarafından satın alındı.
                            <br>
                            <small style="color:#999;">${new Date(notif.date).toLocaleDateString('tr-TR')} ${new Date(notif.date).toLocaleTimeString('tr-TR')}</small>
                        </div>
                    </div>
                `;
                container.appendChild(notifDiv);
            });
        }

        // --- Edit / Delete Logic ---

        function deleteProduct(index) {
            if (confirm('Bu ürünü silmek istediğinize emin misiniz?')) {
                currentProducts.splice(index, 1);
                localStorage.setItem('products', JSON.stringify(currentProducts));
                loadProducts();
                loadStats();
            }
        }

        function enableEdit(index, btn) {
            const nameEl = document.getElementById(`name-${index}`);
            const priceEl = document.getElementById(`price-${index}`);
            const saveContainer = document.getElementById(`save-actions-${index}`);

            nameEl.contentEditable = true;
            priceEl.contentEditable = true;
            nameEl.style.border = "1px dashed #ccc";
            priceEl.style.border = "1px dashed #ccc";
            nameEl.focus();

            btn.parentElement.style.display = 'none'; // hide edit/delete btns
            saveContainer.style.display = 'flex';
        }

        function cancelEdit(index) {
            loadProducts(); // Simply reload to reset
        }

        function saveEdit(index) {
            const nameEl = document.getElementById(`name-${index}`);
            const priceEl = document.getElementById(`price-${index}`);

            const newName = nameEl.innerText;
            const newPrice = priceEl.innerText.replace(' TL', '').trim(); // simple parse

            currentProducts[index].name = newName;
            currentProducts[index].price = newPrice;

            localStorage.setItem('products', JSON.stringify(currentProducts));
            alert('Ürün güncellendi!');
            loadProducts();
        }
         // Render user's listed products (from localStorage 'products')
        function renderMyProducts() {
            const grid = document.getElementById('productsGrid');
            if (!grid) return;

            const allProducts = JSON.parse(localStorage.getItem('products') || '[]');
            const totalProductsEl = document.getElementById('totalProducts');
            
            // Update total product count
            totalProductsEl.textContent = allProducts.length;
            
            grid.innerHTML = '';

            if (!allProducts || allProducts.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column:1/-1; text-align:center; padding:2rem; background:#fff; border:1px solid #eee; border-radius:12px; color:#777;">
                        <i class="fas fa-box-open" style="font-size:2rem; color:#bbb; margin-bottom:0.5rem;"></i>
                        <div>Henüz satışta ürününüz yok.</div>
                        <a href="urun.html" style="display:inline-block; margin-top:8px; color:#8B6B47; font-weight:600;">Hemen ürün ekle</a>
                    </div>
                `;
                return;
            }

            allProducts.forEach((p, idx) => {
                const card = document.createElement('div');
                card.style.border = '1px solid #eee';
                card.style.borderRadius = '12px';
                card.style.overflow = 'hidden';
                card.style.background = '#fff';
                card.style.display = 'flex';
                card.style.flexDirection = 'column';

                const imgBox = document.createElement('div');
                imgBox.style.aspectRatio = '4/3';
                imgBox.style.background = '#f7f7f7';
                imgBox.style.display = 'flex';
                imgBox.style.alignItems = 'center';
                imgBox.style.justifyContent = 'center';

                if (p.image) {
                    const img = document.createElement('img');
                    img.src = p.image;
                    img.alt = p.name || 'Ürün';
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    imgBox.appendChild(img);
                } else {
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-image';
                    icon.style.fontSize = '2rem';
                    icon.style.color = '#bbb';
                    imgBox.appendChild(icon);
                }

                const body = document.createElement('div');
                body.style.padding = '12px';
                body.style.flex = '1';
                body.innerHTML = `
                    <div style="font-size:12px; color:#8B6B47; font-weight:600;">${p.category || 'Genel'}</div>
                    <div style="font-size:16px; font-weight:600; margin-top:4px; word-break:break-word;" id="pname-${idx}" contenteditable="false">${p.name || 'İsimsiz Ürün'}</div>
                    <div style="font-size:14px; color:#333; margin-top:6px;" id="pprice-${idx}" contenteditable="false">${p.price ? p.price + ' TL' : ''}</div>
                    <div style="display:flex; gap:6px; margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
                        <button type="button" onclick="enableProductEdit(${idx})" style="flex:1; padding:6px 8px; background:#8B6B47; color:#fff; border:none; border-radius:6px; font-size:13px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:4px;">
                            <i class="fas fa-pen" style="font-size:12px;"></i> Düzenle
                        </button>
                        <button type="button" onclick="deleteProductFromProfile(${idx})" style="flex:1; padding:6px 8px; background:#e74c3c; color:#fff; border:none; border-radius:6px; font-size:13px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:4px;">
                            <i class="fas fa-trash" style="font-size:12px;"></i> Sil
                        </button>
                    </div>
                    <div id="psave-${idx}" style="display:none; gap:6px; margin-top:10px;">
                        <button type="button" onclick="saveProductEdit(${idx})" style="flex:1; padding:6px 8px; background:#4CAF50; color:#fff; border:none; border-radius:6px; font-size:13px; cursor:pointer;">Kaydet</button>
                        <button type="button" onclick="cancelProductEdit(${idx})" style="flex:1; padding:6px 8px; background:#999; color:#fff; border:none; border-radius:6px; font-size:13px; cursor:pointer;">İptal</button>
                    </div>
                `;

                card.appendChild(imgBox);
                card.appendChild(body);
                grid.appendChild(card);
            });
        }

        // Product edit/delete handlers
        function enableProductEdit(idx) {
            const nameEl = document.getElementById(`pname-${idx}`);
            const priceEl = document.getElementById(`pprice-${idx}`);
            const saveDiv = document.getElementById(`psave-${idx}`);
            const parentDiv = nameEl.parentElement;

            nameEl.contentEditable = true;
            priceEl.contentEditable = true;
            nameEl.style.border = '1px dashed #999';
            priceEl.style.border = '1px dashed #999';
            nameEl.focus();

            parentDiv.querySelectorAll('button').forEach(b => {
                if (!b.closest('#psave-' + idx)) {
                    b.style.display = 'none';
                }
            });
            saveDiv.style.display = 'flex';
        }

        function saveProductEdit(idx) {
            const nameEl = document.getElementById(`pname-${idx}`);
            const priceEl = document.getElementById(`pprice-${idx}`);

            const newName = nameEl.innerText.trim();
            const newPrice = priceEl.innerText.replace(' TL', '').trim();

            const products = JSON.parse(localStorage.getItem('products') || '[]');
            if (products[idx]) {
                products[idx].name = newName;
                products[idx].price = newPrice;
                localStorage.setItem('products', JSON.stringify(products));
                alert('✅ Ürün güncellendi!');
                renderMyProducts();
            }
        }

        function cancelProductEdit(idx) {
            renderMyProducts();
        }

        function deleteProductFromProfile(idx) {
            if (confirm('Bu ürünü silmek istediğinize emin misiniz?')) {
                const products = JSON.parse(localStorage.getItem('products') || '[]');
                products.splice(idx, 1);
                localStorage.setItem('products', JSON.stringify(products));
                renderMyProducts();
            }
        }

        const showBtn = document.getElementById('showMyProductsBtn');
        if (showBtn) {
            showBtn.addEventListener('click', renderMyProducts);
        }

        // Cashbox functions
        function showCashbox() {
            const modal = document.getElementById('cashboxModal');
            if (!modal) return;
            updateCashboxAmount();
            modal.style.display = 'block';
            modal.animate([{ transform: 'translateY(20px)', opacity: 0 }, { transform: 'translateY(0)', opacity: 1 }], { duration: 250, easing: 'ease-out' });
        }

        function closeCashbox() {
            const modal = document.getElementById('cashboxModal');
            if (!modal) return;
            modal.style.display = 'none';
        }

        function refreshCashbox() { updateCashboxAmount(); }

        function withdrawPlaceholder() { alert('Çekim işlemi demo modunda devre dışı'); }

        function updateCashboxAmount() {
            const currentUserEmail = JSON.parse(localStorage.getItem('currentUser') || '{}').email || '';
            const balances = JSON.parse(localStorage.getItem('balances') || '{}');
            const amount = balances[currentUserEmail] || 0;
            document.getElementById('cashboxAmount').textContent = amount + ' TL';
        }

        // Confetti simple implementation
        function showConfetti() {
            const container = document.getElementById('confettiContainer');
            if (!container) return;
            container.style.display = 'block';
            for (let i = 0; i < 60; i++) {
                const el = document.createElement('div');
                el.style.position = 'absolute';
                el.style.left = Math.random() * 100 + '%';
                el.style.top = '-10%';
                el.style.width = '10px';
                el.style.height = '18px';
                el.style.background = ['#ff6b6b','#ffd54f','#8B6B47','#a3e635','#60a5fa'][Math.floor(Math.random()*5)];
                el.style.opacity = 0.95;
                el.style.transform = `rotate(${Math.random()*360}deg)`;
                el.style.borderRadius = '2px';
                container.appendChild(el);
                const endY = window.innerHeight + 100;
                const duration = 2000 + Math.random()*1500;
                el.animate([{ transform: `translateY(${endY}px)` }], { duration: duration, easing: 'cubic-bezier(.2,.6,.2,1)' });
                setTimeout(() => el.remove(), duration + 50);
            }
            setTimeout(() => { container.style.display = 'none'; }, 3500);
        }

        // Listen for storage events (other tabs) to trigger confetti/notifications
        window.addEventListener('storage', (e) => {
            if (e.key === 'latestSale') {
                try {
                    const sale = JSON.parse(e.newValue || '{}');
                    const currentUserEmail = JSON.parse(localStorage.getItem('currentUser') || '{}').email || '';
                    if (sale && sale.sellerEmail === currentUserEmail) {
                        // Seller got a sale in another tab
                        showConfetti();
                        // Refresh stats and sold lists
                        loadStats();
                        loadSoldProducts();
                    }
                } catch (err) { }
            }
        });
    </script>
</body>

</html>